angular.module("vnUniApp",["ngTagsInput","ngDialog","angucomplete-alt","angularSpinner","ngRoute","ngResource","appRoutes","HomeCtrl","HomeService","UniCtrl","UniService","DBCtrl","DBService","UserModule","MarkCtrl","MarkService"]),angular.module("appRoutes",[]).config(["$routeProvider","$locationProvider",function($routeProvider,$locationProvider){$routeProvider.when("/",{templateUrl:"views/home.html",controller:"HomeController"}).when("/:id/thongtin",{templateUrl:"views/uni_thongtin.html",controller:"UniController"}).when("/:id/khoadaotao",{templateUrl:"views/uni_khoadaotao.html",controller:"UniController"}).when("/:id/xemdiemchuan",{templateUrl:"views/uni_xemdiemchuan.html",controller:"UniController"}).when("/:id/tuyensinh",{templateUrl:"views/uni_tuyensinh.html",controller:"UniController"}).when("/:id/lienhe",{templateUrl:"views/uni_lienhe.html",controller:"UniController"}).when("/login",{templateUrl:"views/login.html",controller:"DBController"}).when("/admin",{templateUrl:"views/admin.html",controller:"ListUniController"}).when("/school_db/:school_id",{templateUrl:"views/school_db.html",controller:"EditUniController"}).when("/login",{templateUrl:"views/login.html",controller:"LoginController"}).when("/diemchuan",{templateUrl:"views/diemchuan.html",controller:"HomeController"}).when("/test",{templateUrl:"views/test.html",controller:"HomeController"}).otherwise({redirecTo:"/"}),$locationProvider.html5Mode(!0)}]),angular.module("DBCtrl",[]).controller("ListUniController",function($scope,$http){$http.get("/list_school").success(function(response){$scope.ds_truong=response})}).controller("EditUniController",function($scope,$http,$routeParams){$scope.school_id=$routeParams.school_id,$scope.url="/uni/"+$scope.school_id,$scope.type=1,$http.get($scope.url).success(function(response){$scope.school=response[0],$scope.school.faculties=[]}),$http.get("/school_type").success(function(response){$scope.list_type=response}),$http.get("/region").success(function(response){$scope.list_region=response}),$http.get("/city").success(function(response){$scope.list_city=response}),$scope.add_faculty=function(){$scope.school.faculties.push({id:$scope.school.faculties.length,name:"none",description:"none",majors:[]})},$scope.rm_faculty=function(){$scope.school.faculties.pop()},$scope.add_major=function(f_id){var mj_id=$scope.school.faculties[0].majors.length;$scope.school.faculties[f_id].majors.push({id:mj_id,name:"none",divisions:[],admissionMarks:[]})},$scope.rm_major=function(f_id){$scope.school.faculties[f_id].majors.pop()}}),angular.module("HomeCtrl",["HomeService"]).controller("HomeController",function($rootScope,$scope,$filter,ngDialog,usSpinnerService,loadFilterService,searchService,searchWithTagsService){function searchComplete(){var nUni=$rootScope.universities.length;console.log(nUni+" universities found"),0==nUni?(ngDialog.open({template:'<div class="ngdialog-message"><center><b>Không tìm được trường nào phù hợp<b><center></div>',plain:"true",className:"ngdialog-theme-default custom-width-small"}),$scope.showResult=!1):$scope.showResult=!0,usSpinnerService.stop("spinner-1")}$scope.showResult=!0,$scope.mucdiemThap=null,$scope.mucdiemCao=null,$scope.ratingPoint=3.5,$scope.ratingChoice=1,$scope.userRating=2032,$scope.isReadonly=!0,$scope.nganhhocSelected=function(selected){$scope.nganhhoc="undefined"==typeof selected?{id:0,name:""}:selected.originalObject},$rootScope.filter={},$rootScope.filter.nganhhoc=loadFilterService.query({name:"nganhhoc"},function(){}),$rootScope.filter.khoithi=loadFilterService.query({name:"khoithi"},function(){$scope.khoithi=$rootScope.filter.khoithi[0]}),$rootScope.filter.vungmien=loadFilterService.query({name:"vungmien"},function(){$scope.vungmien=$rootScope.filter.vungmien[0]}),$rootScope.filter.thanhpho=loadFilterService.query({name:"thanhpho"},function(){$scope.thanhpho=$rootScope.filter.thanhpho[0]}),$rootScope.filter.loaitruong=loadFilterService.query({name:"loaitruong"},function(){$scope.loaitruong=$rootScope.filter.loaitruong[0]}),$scope.loadTags=function($query){for(var tags=[],i=0;i<$rootScope.filter.nganhhoc.length;i++){var tag=$rootScope.filter.nganhhoc[i];tag.field="M",tags.push(tag)}for(var i=0;i<$rootScope.filter.khoithi.length;i++){var tag=$rootScope.filter.khoithi[i];0!=tag.id&&(tag.field="D",tags.push(tag))}for(var i=0;i<$rootScope.filter.vungmien.length;i++){var tag=$rootScope.filter.vungmien[i];0!=tag.id&&(tag.field="R",tags.push(tag))}for(var i=0;i<$rootScope.filter.thanhpho.length;i++){var tag=$rootScope.filter.thanhpho[i];0!=tag.id&&(tag.field="C",tags.push(tag))}for(var i=0;i<$rootScope.filter.loaitruong.length;i++){var tag=$rootScope.filter.loaitruong[i];0!=tag.id&&(tag.field="T",tags.push(tag))}for(var j,x,i=tags.length;i;j=Math.floor(Math.random()*i),x=tags[--i],tags[i]=tags[j],tags[j]=x);return tags.filter(function(tag){return-1!=tag.name.toLowerCase().indexOf($query.toLowerCase())})},$scope.search=function(){var min=0,max=30;"undefined"!=typeof $scope.mucdiemThap&&"undefined"!=typeof $scope.mucdiemCao&&(null!==$scope.mucdiemThap&&null!==$scope.mucdiemCao&&$scope.mucdiemThap>$scope.mucdiemCao?ngDialog.open({template:'<div class="ngdialog-message"><center><b>Mức điểm bạn nhập chưa hợp lý!<b><center></div>',plain:"true",className:"ngdialog-theme-default custom-width-small"}):(null!==$scope.mucdiemThap&&(min=$scope.mucdiemThap),null!==$scope.mucdiemCao&&(max=$scope.mucdiemCao),$scope.showResult=!1,usSpinnerService.spin("spinner-1"),$rootScope.universities=searchService.query({nganhhoc:"undefined"==typeof $scope.nganhhoc?0:$scope.nganhhoc.id,khoithi:"undefined"==typeof $scope.khoithi?0:$scope.khoithi.id,vungmien:"undefined"==typeof $scope.vungmien?0:$scope.vungmien.id,thanhpho:"undefined"==typeof $scope.thanhpho||$scope.thanhpho.region!=$scope.vungmien.id?0:$scope.thanhpho.id,loaitruong:"undefined"==typeof $scope.loaitruong?0:$scope.loaitruong.id,mucdiemThap:min,mucdiemCao:max},searchComplete)))},$scope.searchWithTags=function(){$scope.showResult=!1,usSpinnerService.spin("spinner-1");for(var tagsParam=[],i=0;i<$scope.tags.length;i++)tagsParam[i]={},tagsParam[i].id=$scope.tags[i].id,tagsParam[i].field=$scope.tags[i].field;$rootScope.universities=searchWithTagsService.query({tags:JSON.stringify(tagsParam)},searchComplete)},$scope.viewDialog=function(uniId){$rootScope.selectedUni=$.grep($rootScope.universities,function(e){return e.id==uniId})[0],ngDialog.open({template:"views/dialog.html",className:"ngdialog-theme-default custom-width"})}}).directive("starRating",function(){return{restrict:"EA",template:"<ul class='rating'> <li ng-repeat='star in stars' ng-class='star' ng-click='toggle($index)'>  <i class='fa fa-star-o  fa-2x'></i> </li></ul>",scope:{ratingValue:"=ngModel",max:"=?",onRatingSelected:"&?",readonly:"=?"},link:function(scope,elem,attrs){function updateStars(){scope.stars=[];for(var i=0;i<scope.max;i++)scope.stars.push({filled:i<scope.ratingValue})}void 0==scope.max&&(scope.max=5),scope.toggle=function(index){(void 0==scope.readonly||0==scope.readonly)&&(scope.ratingValue=index+1,scope.onRatingSelected({rating:index+1}))},scope.$watch("ratingValue",function(oldVal,newVal){newVal&&updateStars()})}}}).filter("thanhphoFilter",function(){return function(thanhphos,vungmien){if("undefined"==typeof vungmien)return thanhphos;if(0==vungmien.id)return thanhphos;var filtered=[];filtered.push(thanhphos[0]);for(var i=0;i<thanhphos.length;i++)thanhphos[i].region==vungmien.id&&filtered.push(thanhphos[i]);return filtered}}).filter("nganhhocFilter",function(){return function(nganhhocs,tennganh){if("undefined"==typeof tennganh)return nganhhocs;var filtered=[];filtered.push(nganhhocs[0]);for(var i=0;i<nganhhocs.length;i++)nganhhocs[i].name.toLowerCase().includes(tennganh.toLowerCase())&&filtered.push(nganhhocs[i]);return filtered}}).config(["usSpinnerConfigProvider",function(usSpinnerConfigProvider){usSpinnerConfigProvider.setDefaults({color:"green"})}]),angular.module("MarkCtrl",["MarkService"]).controller("MarkController",function($rootScope,$scope,ngDialog,usSpinnerService,loadUniversityService,loadMarkService){$scope.showResult=!1,$scope.showLoading=!1,$scope.uniId=0,$scope.uniSelected=function(selected){"undefined"!=typeof selected&&($scope.uniId=selected.originalObject.id)},$scope.universities=loadUniversityService.query({},function(){}),$scope.getUniMark=function(){0==$scope.uniId?ngDialog.open({template:"<h3>Hãy chọn trường bạn muốn xem!</h3>",plain:"true",className:"ngdialog-theme-default custom-width"}):(usSpinnerService.spin("spinner-2"),$scope.showResult=!1,$scope.showLoading=!0,$scope.uniMajors=loadMarkService.query({id:$scope.uniId},function(){$scope.showLoading=!1,$scope.showResult=!0,$scope.majors=$scope.uniMajors[0].majors;for(var i=0;i<$scope.majors.length;i++){for(var division="",j=0;j<$scope.majors[i].divisions.length;j++)division+=String($scope.majors[i].divisions[j]+", ");$scope.majors[i].divisions=division.substring(0,division.length-2)}}))}}),angular.module("UniCtrl",["UniService"]).controller("UniController",function($rootScope,$scope,$routeParams,$location,getUniInforService){var url=$location.url(),needInfor=url.split("/")[2];$scope.uniId=String($routeParams.id),$scope.uniInfor=getUniInforService.query({id:$scope.uniId,need:needInfor},function(){if($scope.uniInfor=$scope.uniInfor[0],$rootScope.uniName!=$scope.uniInfor.name&&($rootScope.uniName=$scope.uniInfor.name),"xemdiemchuan"==needInfor)for(var i=0;i<$scope.uniInfor.majors.length;i++){for(var division="",j=0;j<$scope.uniInfor.majors[i].divisions.length;j++)division+=String($scope.uniInfor.majors[i].divisions[j]+", ");$scope.uniInfor.majors[i].divisions=division.substring(0,division.length-2)}})}),angular.module("UserModule",[]).controller("LoginController",function($scope,$http,$window){$scope.login=function(username,password){$http.post("/authenticate",{username:username,password:password}).success(function(response){console.log(response),$window.location.href=response}).error(function(response){})}}),angular.module("DBService",[]).factory("Database",["$http",function($http){}]),angular.module("HomeService",["ngResource"]).factory("loadFilterService",function($resource){return $resource("/filter/:name",{},{query:{method:"GET",isArray:!0}})}).factory("searchService",function($resource){return $resource("/search",{},{query:{method:"GET",isArray:!0}})}).factory("searchWithTagsService",function($resource){return $resource("/searchwithtags",{},{query:{method:"GET",isArray:!0}})}),angular.module("MarkService",["ngResource"]).factory("loadUniversityService",function($resource){return $resource("/mark",{},{query:{method:"GET",isArray:!0}})}).factory("loadMarkService",function($resource){return $resource("/mark/:id",{},{query:{method:"GET",isArray:!0}})}),angular.module("UniService",["ngResource"]).factory("getUniInforService",function($resource){return $resource("/infor/:id/:need",{},{query:{method:"GET",isArray:!0}})});